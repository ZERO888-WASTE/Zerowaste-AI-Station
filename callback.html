<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Callback - Zerowaste AI Station</title>
</head>
<body>
  <h2>กำลังตรวจสอบข้อมูล...</h2>
  <div id="result"></div>

  <script>
    async function fetchTokenAndProfile() {
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');

      if (!code) {
        document.getElementById("result").innerText = "ไม่พบรหัสโค้ดจาก LINE";
        return;
      }

      const response = await fetch("https://api.line.me/oauth2/v2.1/token", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: new URLSearchParams({
          grant_type: "authorization_code",
          code: code,
          redirect_uri: "https://zero888-waste.github.io/Zerowaste-AI-Station/callback.html",
          client_id: "2007537369",
          client_secret: "7b8eee0881678fe3ec501d63ab96913f"
        })
      });

      const tokenData = await response.json();
      const accessToken = tokenData.access_token;

      const profileRes = await fetch("https://api.line.me/v2/profile", {
        headers: {
          Authorization: "Bearer " + accessToken
        }
      });

      const profile = await profileRes.json();

      document.getElementById("result").innerHTML = `
        <h3>ยินดีต้อนรับ ${profile.displayName}</h3>
        <p>User ID: ${profile.userId}</p>
      `;

      await fetch("https://script.google.com/macros/s/AKfycbyntinM34yaRhuOP-FHjBSZ5cTiEyirC1rW1Fn2NoB5Ky4mkoFQARm3X3Uv565jIGs8rQ/exec", {
        method: "POST",
        mode: "no-cors",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          displayName: profile.displayName,
          userId: profile.userId
        })
      });
    }

    fetchTokenAndProfile();
  </script>
</body>
</html>
